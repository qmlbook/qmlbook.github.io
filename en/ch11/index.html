<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>11. Networking &#8212; Qt5 Cadaques Book v2018-06</title>
    
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2018-06',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="12. Storage" href="../ch12/index.html" />
    <link rel="prev" title="10. Multimedia" href="../ch10/index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          QmlBook</a>
        <span class="navbar-text navbar-version pull-left"><b>2018-06</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Chapters <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ch01/index.html">1. Meet Qt 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch02/index.html">2. Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch03/index.html">3. Qt Creator IDE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch04/index.html">4. Quick Starter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch05/index.html">5. Fluid Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch06/index.html">6. Model-View-Delegate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch07/index.html">7. Canvas Element</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch08/index.html">8. Particle Simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch09/index.html">9. Shader Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch10/index.html">10. Multimedia</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">11. Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch12/index.html">12. Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch13/index.html">13. Dynamic QML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch14/index.html">14. JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch15/index.html">15. Qt and C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ch16/index.html">16. Extending QML with C++</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">11. Networking</a><ul>
<li><a class="reference internal" href="#serving-ui-via-http">11.1. Serving UI via HTTP</a><ul>
<li><a class="reference internal" href="#networked-components">11.1.1. Networked Components</a></li>
</ul>
</li>
<li><a class="reference internal" href="#templating">11.2. Templating</a></li>
<li><a class="reference internal" href="#http-requests">11.3. HTTP Requests</a><ul>
<li><a class="reference internal" href="#flickr-calls">11.3.1. Flickr Calls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#local-files">11.4. Local files</a></li>
<li><a class="reference internal" href="#rest-api">11.5. REST API</a><ul>
<li><a class="reference internal" href="#read-request">11.5.1. Read Request</a></li>
<li><a class="reference internal" href="#read-entry">11.5.2. Read Entry</a></li>
<li><a class="reference internal" href="#create-entry">11.5.3. Create Entry</a></li>
<li><a class="reference internal" href="#update-entry">11.5.4. Update Entry</a></li>
<li><a class="reference internal" href="#delete-entry">11.5.5. Delete Entry</a></li>
<li><a class="reference internal" href="#client-rest">11.5.6. Client REST</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authentication-using-oauth">11.6. Authentication using OAuth</a></li>
<li><a class="reference internal" href="#engin-io">11.7. Engin IO</a></li>
<li><a class="reference internal" href="#web-sockets">11.8. Web Sockets</a><ul>
<li><a class="reference internal" href="#ws-server">11.8.1. WS Server</a></li>
<li><a class="reference internal" href="#ws-client">11.8.2. WS Client</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">11.9. Summary</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="../ch10/index.html" title="Previous Chapter: 10. Multimedia"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 10. Multimedia</span>
    </a>
  </li>
  <li>
    <a href="../ch12/index.html" title="Next Chapter: 12. Storage"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">12. Storage &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">11. Networking</a><ul>
<li><a class="reference internal" href="#serving-ui-via-http">11.1. Serving UI via HTTP</a><ul>
<li><a class="reference internal" href="#networked-components">11.1.1. Networked Components</a></li>
</ul>
</li>
<li><a class="reference internal" href="#templating">11.2. Templating</a></li>
<li><a class="reference internal" href="#http-requests">11.3. HTTP Requests</a><ul>
<li><a class="reference internal" href="#flickr-calls">11.3.1. Flickr Calls</a></li>
</ul>
</li>
<li><a class="reference internal" href="#local-files">11.4. Local files</a></li>
<li><a class="reference internal" href="#rest-api">11.5. REST API</a><ul>
<li><a class="reference internal" href="#read-request">11.5.1. Read Request</a></li>
<li><a class="reference internal" href="#read-entry">11.5.2. Read Entry</a></li>
<li><a class="reference internal" href="#create-entry">11.5.3. Create Entry</a></li>
<li><a class="reference internal" href="#update-entry">11.5.4. Update Entry</a></li>
<li><a class="reference internal" href="#delete-entry">11.5.5. Delete Entry</a></li>
<li><a class="reference internal" href="#client-rest">11.5.6. Client REST</a></li>
</ul>
</li>
<li><a class="reference internal" href="#authentication-using-oauth">11.6. Authentication using OAuth</a></li>
<li><a class="reference internal" href="#engin-io">11.7. Engin IO</a></li>
<li><a class="reference internal" href="#web-sockets">11.8. Web Sockets</a><ul>
<li><a class="reference internal" href="#ws-server">11.8.1. WS Server</a></li>
<li><a class="reference internal" href="#ws-client">11.8.2. WS Client</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary">11.9. Summary</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="networking">
<h1>11. Networking<a class="headerlink" href="#networking" title="Permalink to this headline">¶</a></h1>
<p><em>Section author: <a class="reference external" href="https://github.com/jryannel">jryannel</a></em></p>
<p><div class="btn-group btn-group-justified" role="group"><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook/" target="_blank">Github</a><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//blob/master/index.rst" target="_blank"><i class="glyphicon glyphicon-file"></i> View</a><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//edit/master/index.rst" target="_blank"><i class="glyphicon glyphicon-pencil"></i> Edit</a><a class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//issues/new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23networking" target="_blank"><i class="glyphicon glyphicon-plus"></i> Issue </a><a  class="btn btn-primary btn-xs" href="https://github.com/qmlbook/qmlbook//issues?labels=ch11&page=1&state=open" target="_blank"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Last Build: June 19, 2018 at 14:39 CET</p>
<p class="last">The source code for this chapter can be found in the <a class="reference external" href="../../assets">assets folder</a>.</p>
</div>
<p>Qt 5 comes with a rich set of networking classes on the C++ side. There are for example high level classes on the http protocol layer in a request-reply fashion such as <code class="docutils literal"><span class="pre">QNetworkRequest</span></code>, <code class="docutils literal"><span class="pre">QNetworkReply</span></code> and <code class="docutils literal"><span class="pre">QNetworkAccessManager</span></code>. But also lower levels classes on the TCP/IP or UDP protocol layer such as <code class="docutils literal"><span class="pre">QTcpSocket</span></code>, <code class="docutils literal"><span class="pre">QTcpServer</span></code> and <code class="docutils literal"><span class="pre">QUdpSocket</span></code>. Additional classes exists to manage proxies, network cache and also the systems network configuration.</p>
<p>This chapter will not be about C++ networking, this chapter is about Qt Quick and networking. So how can I connect my QML/JS user interface directly with a network service or how can I serve my user interface via a network service. There are good books and references out there to cover network programming with Qt/C++. Then it is just a manner to read the chapter about C++ integration to come up with an integration layer to feed your data into the Qt Quick world.</p>
<div class="section" id="serving-ui-via-http">
<h2>11.1. Serving UI via HTTP<a class="headerlink" href="#serving-ui-via-http" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23serving-ui-via-http"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>To load a simple user interface via HTTP we need to have a web-server, which serves the UI documents. We start of with our own simple web-server using a python one-liner. But first we need to have our demo user interface. For this we create a small <code class="docutils literal"><span class="pre">main.qml</span></code> file in our project folder and create a red rectangle inside.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// main.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">Rectangle</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">320</span>
    <span class="k">height:</span> <span class="mi">320</span>
    <span class="k">color:</span> <span class="s1">&#39;#ff0000&#39;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To serve this file we launch a small python script:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span>$ cd &lt;PROJECT&gt;
# python -m SimpleHTTPServer 8080
</pre></div>
</div>
<p>Now our file should be reachable via <code class="docutils literal"><span class="pre">http://localhost:8080/main.qml</span></code>. You can test it with:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">curl</span> <span class="k">http:</span><span class="c1">//localhost:8080/main.qml</span>
</pre></div>
</div>
<p>Or just point your browser to the location. Your browser does not understand QML and will not be able to render the document through. We need to create now such a browser for QML documents. To render the document we need to point our <code class="docutils literal"><span class="pre">qmlscene</span></code> to the location. Unfortunately the <code class="docutils literal"><span class="pre">qmlscene</span></code> is limited to local files only. We could overcome this limitation by writing our own <code class="docutils literal"><span class="pre">qmlscene</span></code> replacement or simple dynamically load it using QML. We choose the dynamic loading as it works just fine. For this we use a loader element to retrieve for us the remote document.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// remote.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">Loader</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="k">source:</span> <span class="s1">&#39;http://localhost:8080/main2.qml&#39;</span>
    <span class="k">onLoaded:</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">width</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">height</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we can ask the <code class="docutils literal"><span class="pre">qmlscene</span></code> to load the local <code class="docutils literal"><span class="pre">remote.qml</span></code> loader document. There is one glitch still. The loader will resize to the size of the loaded item. And our <code class="docutils literal"><span class="pre">qmlscene</span></code> needs also to adapt to that size. This can be accomplished using the <code class="docutils literal"><span class="pre">--resize-to-root</span></code> option to the <code class="docutils literal"><span class="pre">qmlscene</span></code>:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">qmlscene</span> <span class="o">--</span><span class="nx">resize</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">root</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">qml</span>
</pre></div>
</div>
<p>Resize to root tells the qml scene to resize its window to the size of the root element. The remote is now loading the <code class="docutils literal"><span class="pre">main.qml</span></code> from our local server and resizes itself to the loaded user interface. Sweet and simple.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If you do not want to run a local server you can also use the gist service from GitHub. Gist is a clipboard like online service like PasteBin and others. It is available under <a class="reference external" href="https://gist.github.com">https://gist.github.com</a> . I created for this example a small gist under the url <a class="reference external" href="https://gist.github.com/jryannel/7983492">https://gist.github.com/jryannel/7983492</a> . This will reveal a green rectangle. As the gist url will provide the web-site as HTML code we need to attach a <code class="docutils literal"><span class="pre">/raw</span></code> to the url to retrieve the raw file and not the HTML code.</p>
<div class="last highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// remote.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">Loader</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="k">source:</span> <span class="s1">&#39;https://gist.github.com/jryannel/7983492/raw&#39;</span>
    <span class="k">onLoaded:</span> <span class="p">{</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">width</span>
        <span class="nx">root</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">height</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>To load another file over the network you just need to reference the component name. For example a <code class="docutils literal"><span class="pre">Button.qml</span></code> can be accessed as normal, as long it is in the same remote folder.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Is this true? What are the rules?</p>
</div>
<div class="section" id="networked-components">
<h3>11.1.1. Networked Components<a class="headerlink" href="#networked-components" title="Permalink to this headline">¶</a></h3>
<p>Let us create a small experiment. We add to our remote side a small button as a reusable component.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="nx">src</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">qml</span>
<span class="o">-</span> <span class="nx">src</span><span class="o">/</span><span class="nx">Button</span><span class="p">.</span><span class="nx">qml</span>
</pre></div>
</div>
<p>We modify our <code class="docutils literal"><span class="pre">main.qml</span></code> to use the button and save it as <code class="docutils literal"><span class="pre">main2.qml</span></code>:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">Rectangle</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">320</span>
    <span class="k">height:</span> <span class="mi">320</span>
    <span class="k">color:</span> <span class="s1">&#39;#ff0000&#39;</span>

    <span class="nx">Button</span> <span class="p">{</span>
        <span class="k">anchors.centerIn:</span> <span class="nx">parent</span>
        <span class="k">text:</span> <span class="s1">&#39;Click Me&#39;</span>
        <span class="k">onClicked:</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">quit</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And launch our web-server again:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span>$ cd src
# python -m SimpleHTTPServer 8080
</pre></div>
</div>
<p>And our remote loader loads the main QML via http again:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">qmlscene</span> <span class="o">--</span><span class="nx">resize</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">root</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">qml</span>
</pre></div>
</div>
<p>What we see is an error:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="k">http:</span><span class="c1">//localhost:8080/main2.qml:11:5: Button is not a type</span>
</pre></div>
</div>
<p>So QML can not resolve the button component when it is loaded remotely. If the code would be locally <code class="docutils literal"><span class="pre">qmlscene</span> <span class="pre">src/main.qml</span></code> this would be no issue. Locally Qt can parse the directory and detect which components are available but remotely there is no &#8220;list-dir&#8221; function for http. We can force QML to load the element using the import statement inside <code class="docutils literal"><span class="pre">main.qml</span></code>:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="s2">&quot;http://localhost:8080&quot;</span> <span class="nx">as</span> <span class="nx">Remote</span>

<span class="p">...</span>

<span class="nx">Remote</span><span class="p">.</span><span class="nx">Button</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div>
</div>
<p>This will work then when the <code class="docutils literal"><span class="pre">qmlscene</span></code> is run again:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">qmlscene</span> <span class="o">--</span><span class="nx">resize</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">root</span> <span class="nx">remote</span><span class="p">.</span><span class="nx">qml</span>
</pre></div>
</div>
<p>Here the full code:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// main2.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>
<span class="kr">import</span> <span class="s2">&quot;http://localhost:8080&quot;</span> <span class="mf">1.0</span> <span class="nx">as</span> <span class="nx">Remote</span>

<span class="nx">Rectangle</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">320</span>
    <span class="k">height:</span> <span class="mi">320</span>
    <span class="k">color:</span> <span class="s1">&#39;#ff0000&#39;</span>

    <span class="nx">Remote</span><span class="p">.</span><span class="nx">Button</span> <span class="p">{</span>
        <span class="k">anchors.centerIn:</span> <span class="nx">parent</span>
        <span class="k">text:</span> <span class="s1">&#39;Click Me&#39;</span>
        <span class="k">onClicked:</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">quit</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A better option is to use the <code class="docutils literal"><span class="pre">qmldir</span></code> file on the server side to control the export.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// qmldir</span>
<span class="nx">Button</span> <span class="mf">1.0</span> <span class="nx">Button</span><span class="p">.</span><span class="nx">qml</span>
</pre></div>
</div>
<p>And then updating the <code class="docutils literal"><span class="pre">main.qml</span></code>:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="s2">&quot;http://localhost:8080&quot;</span> <span class="mf">1.0</span> <span class="nx">as</span> <span class="nx">Remote</span>

<span class="p">...</span>

<span class="nx">Remote</span><span class="p">.</span><span class="nx">Button</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Loading</p>
</div>
<p>When using components from a local file system, they are created immediately without a latency. When components are loaded via the network they are created asynchronously. This has the effect that the time of creation is unknown and an element may not yet be fully loaded when others are already completed. Take this into account when working with components loaded over the network.</p>
</div>
</div>
<div class="section" id="templating">
<h2>11.2. Templating<a class="headerlink" href="#templating" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23templating"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>When working with HTML projects they often use template driven development. A small HTML stub is expanded on the server side with code generated by the server using a template mechanism. For example for a photo list the list header would be coded in HTML and the dynamic image list would be dynamically generated using a template mechanism. In general this can also be done using QML but there are some issues with it.</p>
<p>First it is not necessary. The reason HTML developers are doing this is to overcome limitations on the HTML backend. There is no component model yet in HTML so dynamic aspects have to be covered using these mechanism or using programmatically javascript on the client side. Many JS frameworks are out there (jQuery, dojo, backbone, angular, ...) to solve this issue and put more logic into the client-side browser to connect with a network service. The client would then just use a web-service API (e.g. serving JSON or XML data) to communicate with the server. This seems also the better approach for QML.</p>
<p>The second issue is the component cache from QML. When QML accesses a component it caches the render-tree and just loads the cached version for rendering. A modified version on disk or remote would not be detected without restarting the client. To overcome this issue we could use a trick. We could use URL fragments to load the url (e.g. <a class="reference external" href="http://localhost:8080/main.qml#1234">http://localhost:8080/main.qml#1234</a>), where &#8216;#1234&#8217; is the fragment. The HTTP server serves always the same document but QML would store this document using the full URL, including the fragment. Every time we would access this URL the fragment would need to change and the QML cache would not get a positive hit. A fragment could be for example the current time in milli seconds or a random number.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">Loader</span> <span class="p">{</span>
    <span class="k">source:</span> <span class="s1">&#39;http://localhost:8080/main.qml#&#39;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In summary templating is possible but not really recommended and does not play to the strength of QML. A better approach is to use web-services which serve JSON or XML data.</p>
</div>
<div class="section" id="http-requests">
<h2>11.3. HTTP Requests<a class="headerlink" href="#http-requests" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23http-requests"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>A http request is in Qt typically done using <code class="docutils literal"><span class="pre">QNetworkRequest</span></code> and <code class="docutils literal"><span class="pre">QNetworkReply</span></code> from the c++ site and then the response would be pushed using the Qt/C++ integration into the QML space. So we try to push the envelope here a little bit to use the current tools Qt Quick gives us to communicate with a network endpoint. For this we use a helper object to make http request, response cycle. It comes in the form of the java script <code class="docutils literal"><span class="pre">XMLHttpRequest</span></code> object.</p>
<p>The <code class="docutils literal"><span class="pre">XMLHttpRequest</span></code> object allows the user to register a response handle function and a url. A request can be sent using one of the http verbs (get, post, put, delete, ...) to make the request. When the response arrive the handle function is called. The handle function is called several times. Every-time the request state has changed (for example headers have arrived or request is done).</p>
<p>Here a short example:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">request</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">HEADERS_RECEIVED</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;HEADERS_RECEIVED&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;http://example.com&quot;</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>For a response you can get the XML format or just the raw text. It is possible to iterate over the resulting XML but more commonly used is the raw text nowadays for a JSON formatted response. The JSON document will be used to convert text to a JS object using <code class="docutils literal"><span class="pre">JSON.parse(text)</span></code>.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
    <span class="nx">print</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the response handler, we access the raw response text and convert it into a javascript object. This JSON object is now a valid JS object (in javascript an object can be an object or an array).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It seems the <code class="docutils literal"><span class="pre">toString()</span></code> conversion first makes the code more stable. Without the explicit conversion I had several times parser errors. Not sure what the cause it.</p>
</div>
<div class="section" id="flickr-calls">
<h3>11.3.1. Flickr Calls<a class="headerlink" href="#flickr-calls" title="Permalink to this headline">¶</a></h3>
<p>Let us have a look on a more real world example. A typical example is to use the Flickr service to retrieve a public feed of the new uploaded pictures. For this we can use the <code class="docutils literal"><span class="pre">http://api.flickr.com/services/feeds/photos_public.gne</span></code> url. Unfortunately it returns by default an XML stream, which could be easily parsed by the <code class="docutils literal"><span class="pre">XmlListModel</span></code> in qml. For the sake of the example we would like to concentrate on JSON data. To become a clean JSON response we need to attach some parameters to the request: <code class="docutils literal"><span class="pre">http://api.flickr.com/services/feeds/photos_public.gne?format=json&amp;nojsoncallback=1</span></code>. This will return a JSON response without the JSON callback.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A JSON callback wraps the JSON response into a function call. This is a shortcut used on HTML programming where a script tag is used to make a JSON request. The response will trigger a local function defined by the callback. There is no mechanism which works with JSON callbacks in QML.</p>
</div>
<p>Let us first examine the response by using curl:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">curl</span> <span class="s2">&quot;http://api.flickr.com/services/feeds/photos_public.gne?format=json&amp;nojsoncallback=1&amp;tags=munich&quot;</span>
</pre></div>
</div>
<p>The response will be something like this:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Recent Uploads tagged munich&quot;</span><span class="p">,</span>
    <span class="p">...</span>
    <span class="s2">&quot;items&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Candle lit dinner in Munich&quot;</span><span class="p">,</span>
        <span class="s2">&quot;media&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;m&quot;</span><span class="o">:</span><span class="s2">&quot;http://farm8.staticflickr.com/7313/11444882743_2f5f87169f_m.jpg&quot;</span><span class="p">},</span>
        <span class="p">...</span>
        <span class="p">},{</span>
        <span class="s2">&quot;title&quot;</span><span class="o">:</span> <span class="s2">&quot;Munich after sunset: a train full of \&quot;must haves\&quot; =&quot;</span><span class="p">,</span>
        <span class="s2">&quot;media&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;m&quot;</span><span class="o">:</span><span class="s2">&quot;http://farm8.staticflickr.com/7394/11443414206_a462c80e83_m.jpg&quot;</span><span class="p">},</span>
        <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">]</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The returned JSON document has a defined structure. An object which has a title and an items property. Where the title is a string and items is an array of objects. When converting this text into a JSON document you can access the individual entries, as it is a valid JS object/array structure.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// JS code</span>
<span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="nx">print</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span> <span class="c1">// =&gt; &quot;Recent Uploads tagged munich&quot;</span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">obj</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// iterate of the items array entries</span>
    <span class="nx">print</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="p">)</span> <span class="c1">// title of picture</span>
    <span class="nx">print</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">media</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span> <span class="c1">// url of thumbnail</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As a valid JS array we can use the <code class="docutils literal"><span class="pre">obj.items</span></code> array also as a model for a list view. We will try to accomplish this now. First we need to retrieve the response and convert it into a valid JS object. And then we can just set the <code class="docutils literal"><span class="pre">response.items</span></code> property as a model to a list view.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">request</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(...)</span> <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
            <span class="c1">// set JS object as model for listview</span>
            <span class="nx">view</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">items</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;http://api.flickr.com/services/feeds/photos_public.gne?format=json&amp;nojsoncallback=1&amp;tags=munich&quot;</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here is the full source code, where we create the request, when the component is loaded. The request response is then used as model for our simple list view.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">Rectangle</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">320</span>
    <span class="k">height:</span> <span class="mi">480</span>
    <span class="nx">ListView</span> <span class="p">{</span>
        <span class="kd">id: view</span>
        <span class="k">anchors.fill:</span> <span class="nx">parent</span>
        <span class="k">delegate:</span> <span class="nx">Thumbnail</span> <span class="p">{</span>
            <span class="k">width:</span> <span class="nx">view</span><span class="p">.</span><span class="nx">width</span>
            <span class="k">text:</span> <span class="nx">modelData</span><span class="p">.</span><span class="nx">title</span>
            <span class="k">iconSource:</span> <span class="nx">modelData</span><span class="p">.</span><span class="nx">media</span><span class="p">.</span><span class="nx">m</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">request</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">HEADERS_RECEIVED</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;HEADERS_RECEIVED&#39;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">)</span>
                <span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
                <span class="nx">view</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">items</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;http://api.flickr.com/services/feeds/photos_public.gne?format=json&amp;nojsoncallback=1&amp;tags=munich&quot;</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">Component.onCompleted:</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When the document is fully loaded ( <code class="docutils literal"><span class="pre">Component.onCompleted</span></code> ) we request the latest feed content from Flickr. On arrival we parse the JSON response and set the <code class="docutils literal"><span class="pre">items</span></code> array as the model for our view. The list view has a delegate, which displays the thumbnail icon and the title text in a row.</p>
<p>An other option would be to have a placeholder <code class="docutils literal"><span class="pre">ListModel</span></code> and append each item onto the list model. To support larger models it is required to support pagination (e.g page 1 of 10) and lazy content retrieval.</p>
</div>
</div>
<div class="section" id="local-files">
<h2>11.4. Local files<a class="headerlink" href="#local-files" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23local-files"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>Is it also possible to load local (XML/JSON) files using the XMLHttpRequest. For example a local file named &#8220;colors.json&#8221; can be loaded using:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;colors.json&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>We use this to read a color table and display it as a grid. It is not possible to modify the file from the Qt Quick side. To store data back to the source we would need a small REST based HTTP server or a native Qt Quick extension for file access.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">Rectangle</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">360</span>
    <span class="k">height:</span> <span class="mi">360</span>
    <span class="k">color:</span> <span class="s1">&#39;#000&#39;</span>

    <span class="nx">GridView</span> <span class="p">{</span>
        <span class="kd">id: view</span>
        <span class="k">anchors.fill:</span> <span class="nx">parent</span>
        <span class="k">cellWidth:</span> <span class="nx">width</span><span class="o">/</span><span class="mi">4</span>
        <span class="k">cellHeight:</span> <span class="nx">cellWidth</span>
        <span class="k">delegate:</span> <span class="nx">Rectangle</span> <span class="p">{</span>
            <span class="k">width:</span> <span class="nx">view</span><span class="p">.</span><span class="nx">cellWidth</span>
            <span class="k">height:</span> <span class="nx">view</span><span class="p">.</span><span class="nx">cellHeight</span>
            <span class="k">color:</span> <span class="nx">modelData</span><span class="p">.</span><span class="nx">value</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">request</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">HEADERS_RECEIVED</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;HEADERS_RECEIVED&#39;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
                <span class="nx">view</span><span class="p">.</span><span class="nx">model</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">colors</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;colors.json&quot;</span><span class="p">);</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">Component.onCompleted:</span> <span class="p">{</span>
        <span class="nx">request</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Instead of using the <code class="docutils literal"><span class="pre">XMLHttpRequest</span></code> is is also possible to use the XmlListModel to access local files.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span><span class="p">.</span><span class="nx">XmlListModel</span> <span class="mf">2.0</span>

<span class="nx">XmlListModel</span> <span class="p">{</span>
    <span class="k">source:</span> <span class="s2">&quot;http://localhost:8080/colors.xml&quot;</span>
    <span class="k">query:</span> <span class="s2">&quot;/colors&quot;</span>
    <span class="nx">XmlRole</span> <span class="p">{</span> <span class="k">name:</span> <span class="s1">&#39;color&#39;</span><span class="p">;</span> <span class="k">query:</span> <span class="s1">&#39;name/string()&#39;</span> <span class="p">}</span>
    <span class="nx">XmlRole</span> <span class="p">{</span> <span class="k">name:</span> <span class="s1">&#39;value&#39;</span><span class="p">;</span> <span class="k">query:</span> <span class="s1">&#39;value/string()&#39;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With the XmlListModel it is only possible to read XML files and not JSON files.</p>
</div>
<div class="section" id="rest-api">
<h2>11.5. REST API<a class="headerlink" href="#rest-api" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23rest-api"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>To use a web-service, we first need to create one. We will use Flask (<a class="reference external" href="http://flask.pocoo.org">http://flask.pocoo.org</a>) a simple HTTP app server based on python to create a simple color web-service. You could also use every other web server which accepts and returns JSON data. The idea is to have a list of named colors, which can be managed via the web-service. Managed in this case means CRUD (create-read-update-delete).</p>
<p>A simple web-service in Flask can be written in one file. We start with an empty <code class="docutils literal"><span class="pre">server.py</span></code> file. Inside this file, we create some boiler-code and load our initial colors from an external JSON file. See also the Flask <a class="reference external" href="http://flask.pocoo.org/docs/quickstart/">quickstart</a> documentation.</p>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="s1">&#39;colors.json&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">))</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># ... service calls go here</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>When you run this script, it will provide a web-server at <a class="reference external" href="http://localhost:5000">http://localhost:5000</a>, which does not serve anything useful yet.</p>
<p>We will now start adding our CRUD (Create,Read,Update,Delete) endpoints to our little web-service.</p>
<div class="section" id="read-request">
<h3>11.5.1. Read Request<a class="headerlink" href="#read-request" title="Permalink to this headline">¶</a></h3>
<p>To read data from our web-server, we will provide a GET method for all colors.</p>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/colors&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_colors</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span> <span class="p">{</span> <span class="s2">&quot;colors&quot;</span> <span class="p">:</span>  <span class="n">colors</span> <span class="p">})</span>
</pre></div>
</div>
<p>This will return the colors under the &#8216;/colors&#8217; endpoint. To test this we can use curl to create a http request.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="nx">curl</span> <span class="o">-</span><span class="nx">i</span> <span class="o">-</span><span class="nx">GET</span> <span class="k">http:</span><span class="c1">//localhost:5000/colors</span>
</pre></div>
</div>
<p>Which will return us the list of colors as JSON data.</p>
</div>
<div class="section" id="read-entry">
<h3>11.5.2. Read Entry<a class="headerlink" href="#read-entry" title="Permalink to this headline">¶</a></h3>
<p>To read an individual color by name we provide the details endpoint, which is located under &#8216;/colors/&lt;name&gt;&#8217;. The name is a parameter to the endpoint, which identifies an individual color.</p>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/colors/&lt;name&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_color</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">color</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span> <span class="n">color</span> <span class="p">)</span>
</pre></div>
</div>
<p>And we can test it with using curl again. For example to get the red color entry.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>curl -i -GET http://localhost:5000/colors/red
</pre></div>
</div>
<p>It will return one color entry as JSON data.</p>
</div>
<div class="section" id="create-entry">
<h3>11.5.3. Create Entry<a class="headerlink" href="#create-entry" title="Permalink to this headline">¶</a></h3>
<p>Till now we have just used HTTP GET methods. To create an entry on the server side, we will use a POST method and pass the new color information with the POST data. The endpoint location is the same as to get all colors. But this time we expect a POST request.</p>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/colors&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_color</span><span class="p">():</span>
    <span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span> <span class="n">color</span> <span class="p">),</span> <span class="mi">201</span>
</pre></div>
</div>
<p>Curl is flexible enough to allow us to provide JSON data as the new entry inside the POST request.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST -d <span class="s1">&#39;{&quot;name&quot;:&quot;gray1&quot;,&quot;value&quot;:&quot;#333&quot;}&#39;</span> http://localhost:5000/colors
</pre></div>
</div>
</div>
<div class="section" id="update-entry">
<h3>11.5.4. Update Entry<a class="headerlink" href="#update-entry" title="Permalink to this headline">¶</a></h3>
<p>To update an individual entry we use the PUT HTTP method. The endpoint is the same as to retrieve an individual color entry. When the color was updated successfully we return the updated color as JSON data.</p>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/colors/&lt;name&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">update_color</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">color</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">color</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">color</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span> <span class="n">color</span> <span class="p">)</span>
</pre></div>
</div>
<p>In the curl request we only provide the values to be updated as JSON data and the a named endpoint to identify the color to be updated.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>curl -i -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X PUT -d <span class="s1">&#39;{&quot;value&quot;:&quot;#666&quot;}&#39;</span> http://localhost:5000/colors/red
</pre></div>
</div>
</div>
<div class="section" id="delete-entry">
<h3>11.5.5. Delete Entry<a class="headerlink" href="#delete-entry" title="Permalink to this headline">¶</a></h3>
<p>Deleting an entry is done using the DELETE HTTP verb. It also uses the same endpoint for an individual color, but this time the DELETE HTTP verb.</p>
<div class="highlight-py"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/colors/&lt;name&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_color</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">color</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span> <span class="p">{</span> <span class="s1">&#39;result&#39;</span> <span class="p">:</span> <span class="n">success</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>This request looks similar like the GET request for an individual color.</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>curl -i -X DELETE http://localhost:5000/colors/red
</pre></div>
</div>
<p>Now we can read all colors, read a specific color, create a new color, update a color and delete a color. Also we know the HTTP endpoints to our API.</p>
<table border="1" class="colwidths-given docutils">
<colgroup>
<col width="40%" />
<col width="20%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Action</th>
<th class="head">HTTP</th>
<th class="head">Endpoint</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Read All</td>
<td>GET</td>
<td><a class="reference external" href="http://localhost:5000/colors">http://localhost:5000/colors</a></td>
</tr>
<tr class="row-odd"><td>Create Entry</td>
<td>POST</td>
<td><a class="reference external" href="http://localhost:5000/colors">http://localhost:5000/colors</a></td>
</tr>
<tr class="row-even"><td>Read Entry</td>
<td>GET</td>
<td><a class="reference external" href="http://localhost:5000/colors">http://localhost:5000/colors</a>/&lt;name&gt;</td>
</tr>
<tr class="row-odd"><td>Update Entry</td>
<td>PUT</td>
<td><a class="reference external" href="http://localhost:5000/colors">http://localhost:5000/colors</a>/&lt;name&gt;</td>
</tr>
<tr class="row-even"><td>Delete Entry</td>
<td>DELETE</td>
<td><a class="reference external" href="http://localhost:5000/colors">http://localhost:5000/colors</a>/&lt;name&gt;</td>
</tr>
</tbody>
</table>
<p>Our little REST server is complete now and we can focus on QML and the client side. To create an easy to use API we need to map each action to an individual HTTP request and provide a simple API to our users.</p>
</div>
<div class="section" id="client-rest">
<h3>11.5.6. Client REST<a class="headerlink" href="#client-rest" title="Permalink to this headline">¶</a></h3>
<p>To demonstrate a REST client we write a small color grid. The color grid displays the colors retrieved from the web-service via HTTP requests. Our user interface provides the following commands:</p>
<ul class="simple">
<li>Get color list</li>
<li>Create color</li>
<li>Read last color</li>
<li>Update last color</li>
<li>Delete last color</li>
</ul>
<p>We bundle our API into an own JS file called <code class="docutils literal"><span class="pre">colorservice.js</span></code> and import it into our UI as <code class="docutils literal"><span class="pre">Service</span></code>. Inside the service module we create a helper function to make the HTTP requests for us:</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// colorservice.js</span>
<span class="kd">function</span> <span class="nx">request</span><span class="p">(</span><span class="nx">verb</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;request: &#39;</span> <span class="o">+</span> <span class="nx">verb</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">BASE</span> <span class="o">+</span> <span class="p">(</span><span class="nx">endpoint</span><span class="o">?</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">endpoint:</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;xhr: on ready state change: &#39;</span> <span class="o">+</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
                <span class="nx">cb</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">verb</span><span class="p">,</span> <span class="nx">BASE</span> <span class="o">+</span> <span class="p">(</span><span class="nx">endpoint</span><span class="o">?</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">endpoint:</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Accept&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">obj</span><span class="o">?</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="o">:</span><span class="s1">&#39;&#39;</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It takes four arguments. The <code class="docutils literal"><span class="pre">verb</span></code>, which defines the HTTP verb to be used (GET, POST, PUT, DELETE). The second parameter is the endpoint to be used as postfix to the BASE address (e.g. &#8216;<a class="reference external" href="http://localhost:5000/colors">http://localhost:5000/colors</a>&#8216;). The third parameter is the optional obj, to be send as JSON data to the service. The last parameter defines a callback to be called, when the response returns. The callback receives a response object with the response data. Before we send the request, we indicate that we send and accept JSON data by modifying the request header.</p>
<p>Using this request helper function we can implement the simple commands we defined earlier (create, read, update, delete):</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// colorservice.js</span>
<span class="kd">function</span> <span class="nx">get_colors</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// GET http://localhost:5000/colors</span>
    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">create_color</span><span class="p">(</span><span class="nx">entry</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// POST http://localhost:5000/colors</span>
    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">entry</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">get_color</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// GET http://localhost:5000/colors/&lt;name&gt;</span>
    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">update_color</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">entry</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// PUT http://localhost:5000/colors/&lt;name&gt;</span>
    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">entry</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">delete_color</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// DELETE http://localhost:5000/colors/&lt;name&gt;</span>
    <span class="nx">request</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code resides in the service implementation. In the UI we use the service to implement our commands. We have a <code class="docutils literal"><span class="pre">ListModel</span></code> with the id <code class="docutils literal"><span class="pre">gridModel</span></code> as data provider for the <code class="docutils literal"><span class="pre">GridView</span></code>. The commands are indicated using a <code class="docutils literal"><span class="pre">Button</span></code> ui element.</p>
<p>Reading the color list from the server.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// rest.qml</span>
<span class="kr">import</span> <span class="s2">&quot;colorservice.js&quot;</span> <span class="nx">as</span> <span class="nx">Service</span>
<span class="p">...</span>
<span class="c1">// read colors command</span>
<span class="nx">Button</span> <span class="p">{</span>
    <span class="k">text:</span> <span class="s1">&#39;Read Colors&#39;</span><span class="p">;</span>
    <span class="k">onClicked:</span> <span class="p">{</span>
        <span class="nx">Service</span><span class="p">.</span><span class="nx">get_colors</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;handle get colors resp: &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resp</span><span class="p">));</span>
            <span class="nx">gridModel</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">entries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">gridModel</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">entries</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Create a new color entry on the server.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// rest.qml</span>
<span class="kr">import</span> <span class="s2">&quot;colorservice.js&quot;</span> <span class="nx">as</span> <span class="nx">Service</span>
<span class="p">...</span>
<span class="c1">// create new color command</span>
<span class="nx">Button</span> <span class="p">{</span>
    <span class="k">text:</span> <span class="s1">&#39;Create New&#39;</span><span class="p">;</span>
    <span class="k">onClicked:</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">count</span><span class="o">-</span><span class="mi">1</span>
        <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">name:</span> <span class="s1">&#39;color-&#39;</span> <span class="o">+</span> <span class="nx">index</span><span class="p">,</span>
            <span class="k">value:</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">hsla</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="nx">Service</span><span class="p">.</span><span class="nx">create_color</span><span class="p">(</span><span class="nx">entry</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;handle create color resp: &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resp</span><span class="p">))</span>
            <span class="nx">gridModel</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Reading a color based on its name.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// rest.qml</span>
<span class="kr">import</span> <span class="s2">&quot;colorservice.js&quot;</span> <span class="nx">as</span> <span class="nx">Service</span>
<span class="p">...</span>
<span class="c1">// read last color command</span>
<span class="nx">Button</span> <span class="p">{</span>
    <span class="k">text:</span> <span class="s1">&#39;Read Last Color&#39;</span><span class="p">;</span>
    <span class="k">onClicked:</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">count</span><span class="o">-</span><span class="mi">1</span>
        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">index</span><span class="p">).</span><span class="nx">name</span>
        <span class="nx">Service</span><span class="p">.</span><span class="nx">get_color</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;handle get color resp:&#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resp</span><span class="p">))</span>
            <span class="nx">message</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">value</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Update a color entry on the server based on the color name.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// rest.qml</span>
<span class="kr">import</span> <span class="s2">&quot;colorservice.js&quot;</span> <span class="nx">as</span> <span class="nx">Service</span>
<span class="p">...</span>
<span class="c1">// update color command</span>
<span class="nx">Button</span> <span class="p">{</span>
    <span class="k">text:</span> <span class="s1">&#39;Update Last Color&#39;</span>
    <span class="k">onClicked:</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">count</span><span class="o">-</span><span class="mi">1</span>
        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">index</span><span class="p">).</span><span class="nx">name</span>
        <span class="kd">var</span> <span class="nx">entry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="k">value:</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">hsla</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">(),</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">).</span><span class="nx">toString</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="nx">Service</span><span class="p">.</span><span class="nx">update_color</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">entry</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;handle update color resp: &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">resp</span><span class="p">))</span>
            <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">count</span><span class="o">-</span><span class="mi">1</span>
            <span class="nx">gridModel</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Delete a color by the color name.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// rest.qml</span>
<span class="kr">import</span> <span class="s2">&quot;colorservice.js&quot;</span> <span class="nx">as</span> <span class="nx">Service</span>
<span class="p">...</span>
<span class="c1">// delete color command</span>
<span class="nx">Button</span> <span class="p">{</span>
    <span class="k">text:</span> <span class="s1">&#39;Delete Last Color&#39;</span>
    <span class="k">onClicked:</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">count</span><span class="o">-</span><span class="mi">1</span>
        <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">index</span><span class="p">).</span><span class="nx">name</span>
        <span class="nx">Service</span><span class="p">.</span><span class="nx">delete_color</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
        <span class="nx">gridModel</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This concludes the CRUD (create, read, update, delete) operations using a REST API. There are also other possibilities to generate a Web-Service API. One could be module based and each module would have an one endpoint. And the API could be defined using JSON RPC (<a class="reference external" href="http://www.jsonrpc.org/">http://www.jsonrpc.org/</a>). Sure also XML based API are possible and but the JSON approach has great advantages as the parsing is build into the QML/JS as part of JavaScript.</p>
</div>
</div>
<div class="section" id="authentication-using-oauth">
<h2>11.6. Authentication using OAuth<a class="headerlink" href="#authentication-using-oauth" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23authentication-using-oauth"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>OAuth is an open protocol to allow secure authorization in a simple and standard method from web, mobile and desktop applications. OAuth is used to authenticate a client against common web-services such as Google, Facebook and Twitter.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For a custom web-service you could also use the standard HTTP authentication for example by using the <code class="docutils literal"><span class="pre">XMLHttpRequest</span></code> username and password in the get method (e.g. <code class="docutils literal"><span class="pre">xhr.open(verb,</span> <span class="pre">url,</span> <span class="pre">true,</span> <span class="pre">username,</span> <span class="pre">password)</span></code>)</p>
</div>
<p>OAuth is currently not part of a QML/JS API. So you would need to write some C++ code and export the authentication to QML/JS. Another issue would be the secure storage of the access token.</p>
<p>Here are some links which we find useful:</p>
<ul class="simple">
<li><a class="reference external" href="http://oauth.net/">http://oauth.net/</a></li>
<li><a class="reference external" href="http://hueniverse.com/oauth/">http://hueniverse.com/oauth/</a></li>
<li><a class="reference external" href="https://github.com/pipacs/o2">https://github.com/pipacs/o2</a></li>
<li><a class="reference external" href="http://www.johanpaul.com/blog/2011/05/oauth2-explained-with-qt-quick/">http://www.johanpaul.com/blog/2011/05/oauth2-explained-with-qt-quick/</a></li>
</ul>
</div>
<div class="section" id="engin-io">
<h2>11.7. Engin IO<a class="headerlink" href="#engin-io" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23engin-io"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>Engin.IO is a web-service run by DIGIA. It enables to access from inside Qt/QML application to the NoSQL storage from Engin.IO. It is a cloud based storage object store with an easy access Qt/QML API and an administration console. If you want to store some data in the cloud from a QML application, this would be an easy entry path with an excellent QML/JS support.</p>
<p>Please refer to the <a class="reference external" href="http://engin.io">EnginIO</a> documentation for further help.</p>
</div>
<div class="section" id="web-sockets">
<h2>11.8. Web Sockets<a class="headerlink" href="#web-sockets" title="Permalink to this headline">¶</a></h2>
<p><div class="btn-group" role="group"><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook//new?labels=ch11&body=back-link%3A+en%2Fch11%2Findex.html%23web-sockets"><i class="glyphicon glyphicon-plus"></i> Issue</a><a class="btn btn-link btn-xs" href="https://github.com/qmlbook/qmlbook/?labels=ch11&page=1&state=open"><i class="glyphicon glyphicon-search"></i> Issues</a></div></p><p>The WebSockets module provides an impementation of the WebSockets protocol for WebSockets clients and servers. It mirrors the Qt CPP module. It allows to send string and binary messages using a full duplex communication channel. A websocket is normally established by making a HTTP connection to the server and the server then &#8220;upgrades&#8221; the connection to a WebSocket connection.</p>
<p>In Qt/QML you can also simple use the <cite>WebSocket</cite> and <cite>WebSocketServer</cite> objects to creates direct websocket connection. The websocket protocol uses the &#8220;ws&#8221; url schema or &#8220;wss&#8221; for a secure connection.</p>
<p>You can use the web socket qml module by importing it first.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">WebSockets</span> <span class="mf">1.0</span>

<span class="nx">WebSocket</span> <span class="p">{</span>
    <span class="kd">id: socket</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To test your web socket we will use the echo server from <a class="reference external" href="http://websocket.org">http://websocket.org</a>.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>
<span class="kr">import</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">WebSockets</span> <span class="mf">1.0</span>

<span class="nx">Text</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">480</span>
    <span class="k">height:</span> <span class="mi">48</span>

    <span class="k">horizontalAlignment:</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">AlignHCenter</span>
    <span class="k">verticalAlignment:</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">AlignVCenter</span>

    <span class="nx">WebSocket</span> <span class="p">{</span>
        <span class="kd">id: socket</span>
        <span class="k">url:</span> <span class="s2">&quot;ws://echo.websocket.org&quot;</span>
        <span class="k">active:</span> <span class="kc">true</span>
        <span class="k">onTextMessageReceived:</span> <span class="p">{</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="nx">message</span>
        <span class="p">}</span>
        <span class="k">onStatusChanged:</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">errorString</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Open</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">socket</span><span class="p">.</span><span class="nx">sendTextMessage</span><span class="p">(</span><span class="s2">&quot;ping&quot;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Closed</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">text</span> <span class="o">+=</span> <span class="s2">&quot;\nSocket closed&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You should see the ping message we send <code class="docutils literal"><span class="pre">socket.sendTextMessage(&quot;ping&quot;)</span></code> as response in the text field.</p>
<div class="figure">
<img alt="../../_images/ws_echo.png" src="../../_images/ws_echo.png" />
</div>
<div class="section" id="ws-server">
<h3>11.8.1. WS Server<a class="headerlink" href="#ws-server" title="Permalink to this headline">¶</a></h3>
<p>You can easily create your own WS server using the C++ part of the Qt WebSocket or use a different WS implementation, which I find very interesting. It is interesting because it allows to connect the amazing rendering quality of QML with the great expanding web application servers. In this example we will use a Node JS based web socket server using the <a class="reference external" href="https://npmjs.org/package/ws">ws</a> module. For this you first need to install <a class="reference external" href="http://nodejs.org/">node js</a>. Afterwards create a <code class="docutils literal"><span class="pre">ws_server</span></code> folder and install the ws package using the node package manager (npm).</p>
<p>The code shall create a simple echo server in NodeJS to echo our messages back to our QML client.</p>
<div class="figure">
<img alt="../../_images/ws_client.png" src="../../_images/ws_client.png" />
</div>
<div class="highlight-sh"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ws_server
$ npm install ws
</pre></div>
</div>
<p>The npm tool downloads and installs the ws package and dependencies into you local folder.</p>
<p>A <code class="docutils literal"><span class="pre">server.js</span></code> file will be our server implementation. The server code will create a web socket server on port 3000 and listens to an incoming connection. On an incoming connection it will send out a greeting and waits for client messages. Each message a client sends on a socket will be send back to the client.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">WebSocketServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">).</span><span class="nx">Server</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocketServer</span><span class="p">({</span> <span class="k">port :</span> <span class="mi">3000</span> <span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;client connected&#39;</span><span class="p">);</span>
	<span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Message: %s&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
		<span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
	<span class="p">});</span>
	<span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Welcome to Awesome Chat&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;listening on port &#39;</span> <span class="o">+</span> <span class="nx">server</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
</pre></div>
</div>
<p>You need to get used to the notation of JavaScript and the function callbacks.</p>
</div>
<div class="section" id="ws-client">
<h3>11.8.2. WS Client<a class="headerlink" href="#ws-client" title="Permalink to this headline">¶</a></h3>
<p>On the client side we need a list view to display the messages and a TextInput for the user to enter a new chat message.</p>
<p>We will use a label with white color in the example.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// Label.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">Text</span> <span class="p">{</span>
    <span class="k">color:</span> <span class="s1">&#39;#fff&#39;</span>
    <span class="k">horizontalAlignment:</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">AlignLeft</span>
    <span class="k">verticalAlignment:</span> <span class="nx">Text</span><span class="p">.</span><span class="nx">AlignVCenter</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Our chat view is a list view, where the text is appended to a list model. Each entry is displayed using a row of prefix and message label. We use a cell width <code class="docutils literal"><span class="pre">cw</span></code> factor to split the with into 24 columns.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// ChatView.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">ListView</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="k">width:</span> <span class="mi">100</span>
    <span class="k">height:</span> <span class="mi">62</span>

    <span class="k">model:</span> <span class="nx">ListModel</span> <span class="p">{}</span>

    <span class="kd">function</span> <span class="nx">append</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">append</span><span class="p">({</span><span class="k">prefix:</span> <span class="nx">prefix</span><span class="p">,</span> <span class="k">message:</span> <span class="nx">message</span><span class="p">})</span>
    <span class="p">}</span>

    <span class="k">delegate:</span> <span class="nx">Row</span> <span class="p">{</span>
        <span class="k">width:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">width</span>
        <span class="k">height:</span> <span class="mi">18</span>
        <span class="nx">property</span> <span class="nx">real</span> <span class="k">cw:</span> <span class="nx">width</span><span class="o">/</span><span class="mi">24</span>
        <span class="nx">Label</span> <span class="p">{</span>
            <span class="k">width:</span> <span class="nx">cw</span><span class="o">*</span><span class="mi">1</span>
            <span class="k">height:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">height</span>
            <span class="k">text:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">prefix</span>
        <span class="p">}</span>
        <span class="nx">Label</span> <span class="p">{</span>
            <span class="k">width:</span> <span class="nx">cw</span><span class="o">*</span><span class="mi">23</span>
            <span class="k">height:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">height</span>
            <span class="k">text:</span> <span class="nx">model</span><span class="p">.</span><span class="nx">message</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The chat input is just a simple text input wrapped with a colored border.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// ChatInput.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>

<span class="nx">FocusScope</span> <span class="p">{</span>
    <span class="kd">id: root</span>
    <span class="k">width:</span> <span class="mi">240</span>
    <span class="k">height:</span> <span class="mi">32</span>
    <span class="nx">Rectangle</span> <span class="p">{</span>
        <span class="k">anchors.fill:</span> <span class="nx">parent</span>
        <span class="k">color:</span> <span class="s1">&#39;#000&#39;</span>
        <span class="k">border.color:</span> <span class="s1">&#39;#fff&#39;</span>
        <span class="k">border.width:</span> <span class="mi">2</span>
    <span class="p">}</span>

    <span class="nx">property</span> <span class="nx">alias</span> <span class="k">text:</span> <span class="nx">input</span><span class="p">.</span><span class="nx">text</span>

    <span class="nx">signal</span> <span class="nx">accepted</span><span class="p">(</span><span class="nx">string</span> <span class="nx">text</span><span class="p">)</span>

    <span class="nx">TextInput</span> <span class="p">{</span>
        <span class="kd">id: input</span>
        <span class="k">anchors.left:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">left</span>
        <span class="k">anchors.right:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">right</span>
        <span class="k">anchors.verticalCenter:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">verticalCenter</span>
        <span class="k">anchors.leftMargin:</span> <span class="mi">4</span>
        <span class="k">anchors.rightMargin:</span> <span class="mi">4</span>
        <span class="k">onAccepted:</span> <span class="nx">root</span><span class="p">.</span><span class="nx">accepted</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
        <span class="k">color:</span> <span class="s1">&#39;#fff&#39;</span>
        <span class="k">focus:</span> <span class="kc">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When the web socket receives a message it appends the message to the chat view. Same applies for a status change. Also when the user enters a chat message a copy is appended to the chat view on the client side and the message is send to the server.</p>
<div class="highlight-qml"><div class="highlight"><pre><span></span><span class="c1">// ws_client.qml</span>
<span class="kr">import</span> <span class="nx">QtQuick</span> <span class="mf">2.5</span>
<span class="kr">import</span> <span class="nx">Qt</span><span class="p">.</span><span class="nx">WebSockets</span> <span class="mf">1.0</span>

<span class="nx">Rectangle</span> <span class="p">{</span>
    <span class="k">width:</span> <span class="mi">360</span>
    <span class="k">height:</span> <span class="mi">360</span>
    <span class="k">color:</span> <span class="s1">&#39;#000&#39;</span>

    <span class="nx">ChatView</span> <span class="p">{</span>
        <span class="kd">id: box</span>
        <span class="k">anchors.left:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">left</span>
        <span class="k">anchors.right:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">right</span>
        <span class="k">anchors.top:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">top</span>
        <span class="k">anchors.bottom:</span> <span class="nx">input</span><span class="p">.</span><span class="nx">top</span>
    <span class="p">}</span>
    <span class="nx">ChatInput</span> <span class="p">{</span>
        <span class="kd">id: input</span>
        <span class="k">anchors.left:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">left</span>
        <span class="k">anchors.right:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">right</span>
        <span class="k">anchors.bottom:</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">bottom</span>
        <span class="k">focus:</span> <span class="kc">true</span>
        <span class="k">onAccepted:</span> <span class="p">{</span>
            <span class="nx">print</span><span class="p">(</span><span class="s1">&#39;send message: &#39;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">)</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">sendTextMessage</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
            <span class="nx">box</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">WebSocket</span> <span class="p">{</span>
        <span class="kd">id: socket</span>

        <span class="k">url:</span> <span class="s2">&quot;ws://localhost:3000&quot;</span>
        <span class="k">active:</span> <span class="kc">true</span>
        <span class="k">onTextMessageReceived:</span> <span class="p">{</span>
            <span class="nx">box</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">onStatusChanged:</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nb">Error</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">box</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;socket error &#39;</span> <span class="o">+</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">errorString</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Open</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">box</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;socket open&#39;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Closed</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">box</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;socket closed&#39;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You need first run the server and then the client. There is no retry connection mechanism in our simple client.</p>
<p>Running the server</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cd</span> <span class="nx">ws_server</span>
<span class="nx">$</span> <span class="nx">node</span> <span class="nx">server</span><span class="p">.</span><span class="nx">js</span>
</pre></div>
</div>
<p>Running the client</p>
<div class="highlight-js"><div class="highlight"><pre><span></span><span class="nx">$</span> <span class="nx">cd</span> <span class="nx">ws_client</span>
<span class="nx">$</span> <span class="nx">qmlscene</span> <span class="nx">ws_client</span><span class="p">.</span><span class="nx">qml</span>
</pre></div>
</div>
<p>When entering text and pressing enter you should see something like this.</p>
<div class="figure">
<img alt="../../_images/ws_client.png" src="../../_images/ws_client.png" />
</div>
</div>
</div>
<div class="section" id="summary">
<h2>11.9. Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>This concludes our chapter about QML networking. Please bear in mind Qt has on the native side a much richer networking API as on the QML side currently. But the idea of the chapter is to push the boundaries of QML networking and how to integrate with cloud based services.</p>
</div>
</div>


    </div>
      
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2012-2018 Jürgen Bocklage-Ryannel and Johan Thelin. This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.<br/>
      Last updated on Jun 19, 2018.<br/>
    </p>
  </div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-46104829-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>